<?php
# For security reasons, these lines should either be included from a
# config file above the Web directory, or possibly captured during a
# login and stored in the SESSION superglobal array

$db = (array_key_exists('db', $_GET)) ? htmlspecialchars($_GET['db']) : '';
$layout =  (array_key_exists('layout', $_GET)) ? htmlspecialchars($_GET['layout']) : '';

if (empty($db) || empty($layout)) {
	echo '<p>Please supply a database and/or layout.</p>';
	echo '<meta http-equiv="refresh" content="5;url=index.php" />';
	exit;
}

define('FM_HOST', '137.82.136.11'); 
define('FM_FILE', $db); 
define('FM_USER', 'botany'); 
define('FM_PASS', 'str@ley');

# grab search criteria, if any has been sent
$criteria = (array_key_exists('criteria', $_GET)) ? htmlspecialchars($_GET['criteria']) : '';

# grab the sort column, if any has been sent
$column = (array_key_exists('column', $_GET)) ? htmlspecialchars($_GET['column']) : '';

$skip = (array_key_exists('skip', $_GET)) ? htmlspecialchars($_GET['skip']) : 0;

$max = (array_key_exists('max', $_GET)) ? htmlspecialchars($_GET['max']) : 25;

# set the layout name for this page
$layout_name = $layout;

# set convenience var
$this_page = $_SERVER['PHP_SELF'];

# initialize our output var
$page_content = '';

# this is the include for the API for PHP
require_once ('FileMaker.php');

# instantiate a new FileMaker object
$fm = new FileMaker(FM_FILE, FM_HOST, FM_USER, FM_PASS);

/*
$layouts = $fm->listLayouts();
echo '<pre>';
print_r($layouts);
echo '</pre>';
exit;
*/

# get the layout as an object
$layout_object = $fm->getLayout($layout_name);

# check for errors
if (FileMaker::isError($layout_object)) {
	die('<p>'.$record->getMessage().' (error '.$record->code.')</p>');
}

# get the fields as an array of objects
$field_objects = $layout_object->getFields();

# create a new search transaction
$request =& $fm->newFindCommand($layout_name);

# indicate that we want an OR search
$request->setLogicalOperator(FILEMAKER_FIND_AND);

# search each field on the layout for the criteria, if any
#
# NOTE: I am using the getResult method of the field object to check
# the data type of the field. Even in a find request, data type
# formatting must be respected. If we didn't check for this, we
# would get an error if we searched a date field for the value
# 'Erica', for example

/*
foreach($field_objects as $field_object) {
	$field_name = $field_object->getName();
	# format the criteria appropriately for the current field data type
	if ($field_object->getResult() == 'date') {
		if (strtotime($criteria)) {
			$request->addFindCriterion($field_name, date('n/j/Y', strtotime($criteria)));
		}
	} elseif ($field_object->getResult() == 'time') {
		if (strtotime($criteria)) {
			$request->addFindCriterion($field_name, date('H:i:s', strtotime($criteria)));
		}
	} elseif ($field_object->getResult() == 'timestamp') {
		if (strtotime($criteria)) {
			$request->addFindCriterion($field_name, date('n/j/Y H:i:s', strtotime($criteria)));
		}
	} elseif ($field_object->getResult() == 'container') {
	# skip this field because it is a container (like a blob) and can't be searched for text
	} else {
		$request->addFindCriterion($field_name, $criteria);
	}
}
*/

$field_names = $_POST;

foreach($field_names as $field_name => $criteria) {
	if($field_name != 'Province_State') {
		$field_name = str_replace('_', ' ', $field_name);
	}
	$request->addFindCriterion($field_name, $criteria);
}


# specify sort column (aka, field), if any
$request->addSortRule($column, 1);

# set number of results to return per page
$request->setRange($skip, $max);

# execute the search transaction
$result = $request->execute();

# check for errors (including no records found)
if (FileMaker::isError($result)) {
	die('<p>'.$result->getMessage().' (error line 123 code '.$result->code.')</p>');
}

# display the found count
$total = $result->getTableRecordCount();
$found = $result->getFoundSetCount();
$s = ($found==1) ? '' : 's';
$header = explode('.', $db);
$page_content .= '<h3>'.ucfirst($header[0]).' Database</h3>';
$to = $skip + 25;

if (!empty($criteria)) {
	$page_content .= '<p class="h1">Your search for "'.$criteria.'" returned '.$found." record{$s} of ".$total.' total</p>';
} else {
	$page_content .= '<p class="h1">Listing '.$skip.' - '.$to.' records of '.$total.' total</p>';
}

# get the result record set as an array of record objects
$record_objects = $result->getRecords();

# list of fields to display in results
$display_array = array('Accession Number' => 'Accession Number',
				 'Scientific Name' => 'Scientific Name',				 
				 'Country' => 'Country',
				 'Province_State' => 'Province/State',
				 'Location' => 'Location',
				 'Collector' => 'Collector',
				 'Number' => 'Collector No.',
				 'Collectors Label' => 'Collectors Label',
				 'Date' => 'Date');

$formatted_results_array = array(); 
$scientific_name_values_array = array('Family', 'Genus', 'Species', 'Subspecies', 'Variety', 'Forma', 'Cultivar');
$scientific_name_values = '';

$i=0;
foreach ($record_objects as $record_object) {
	foreach($field_objects as $field_object) {
		$field_name = $field_object->getName();
		$field_val = $record_object->getField($field_name);
		$field_val = htmlspecialchars($field_val, ENT_QUOTES);
		$field_val = nl2br($field_val);
		
		if (array_key_exists($field_name, $display_array)) {
			$formatted_results_array[$i]['rec_id'] = $record_object->getRecordId();
			$formatted_results_array[$i][$display_array[$field_name]] = $field_val;
		}

		if (in_array($field_name, $scientific_name_values_array)) {
			if (!empty($field_val)) {
				$scientific_name_values .= $field_val . ', ';
			}
		}
		
		$formatted_results_array[$i]['Scientific Name'] = $scientific_name_values;
	}
	$scientific_name_values = '';
	$i++;
}

/*
echo '<pre>';
print_r($formatted_results_array) . '<br />';
echo '</pre>';
*/

# start compiling our record output
$page_content .= '<table border="0" cellspacing="1" cellpadding="1" class="h1">';
$page_content .= '<tr bgcolor="#CCCCCC">';
# loop through array of field objects to draw header
foreach($field_objects as $field_object) {
	$field_name = $field_object->getName();
	if ($field_name == 'Accession Number') {
		$page_content .= '<td><strong><a href="'.$this_page.'?db='.$db.'&layout='.$layout.'&criteria='.$criteria.'&column='.$column.'">'.$display_array[$field_name].'</a></strong></td>';		
		$page_content .= '<td><strong><a href="'.$this_page.'?db='.$db.'&layout='.$layout.'&criteria='.$criteria.'&column=Genus">Scientific Name</a></strong></td>';	
	}	
	elseif (array_key_exists($field_name, $display_array)) {
		$page_content .= '<td><strong><a href="'.$this_page.'?db='.$db.'&layout='.$layout.'&criteria='.$criteria.'&column='.$column.'">'.$display_array[$field_name].'</a></strong></td>';
	}
}
$page_content .= '</tr>';
 
# loop through formatted results array
$layout_details = str_replace('advanced','details',$layout);
$i=0;
foreach($formatted_results_array as $formatted_results) {
	if ($i % 2 == 0) { $bgc = "#EEEEEE"; } else { $bgc = "#FFFFFF"; }	
	$page_content .= '<tr bgcolor="'.$bgc.'">';
	foreach($formatted_results as $key => $val) {
		if ($key == 'rec_id') {
			continue;		
		}		
		if ($key == 'Accession Number') { 
			$page_content .= '<td><a href="image.php?db='.$db.'&layout='.$layout.'&recid='.$formatted_results_array[$i]['rec_id'].'"><img src="./images/ico_camera.gif " border="0" /></a> <a href="details.php?db='.$db.'&layout='.$layout_details.'&recid='.$formatted_results_array[$i]['rec_id'].'">'.$val.'</a></td>';	
		} else {
			$page_content .= '<td>'.$val.'</td>';
		}
	}
	$page_content .= '</tr>';
	$i++;
}

/*
foreach ($record_objects as $record_object) {
	$page_content .= '<tr>';
	# loop through array of field objects
	foreach($field_objects as $field_object) {
		$field_name = $field_object->getName();
		$field_val = $record_object->getField($field_name);
		$field_val = htmlspecialchars($field_val, ENT_QUOTES);
		$field_val = nl2br($field_val);
		if (array_key_exists($field_name, $display_array)) {		
			if ($field_name == 'Accession Number') { 
				$page_content .= '<td><a href="image.php?recid='.$record_object->getRecordId().'"><img src="./images/ico_camera.gif " border="0" /></a> <a href="details.php?recid='.$record_object->getRecordId().'">'.$field_val.'</a></td>';		
			} else {
				$page_content .= '<td>'.$field_val.'</td>';
			}
		}
	}
	
	$page_content .= '</tr>';
}
*/
$page_content .= '</table>'."\n";

# skip trough results 25 records at a time
$skip = $skip + 25;
$page_content .= '<h2><a href="search_results.php?db='.$db.'&layout='.$layout.'&criteria='.$criteria.'&column='.$column.'&skip='.$skip.'&max='.$max.'">Next 25 Results >></a></h2>' . "\n";
?>
<?php include 'includes/header.php'; ?>
<?php echo $page_content; ?>
<?php include 'includes/footer.php'; ?>
