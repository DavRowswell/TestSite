<?php 
	session_start();	
	include 'includes/header.php';
	$db = (array_key_exists('db', $_GET)) ? htmlspecialchars($_GET['db']) : '';
	$layout_name = str_replace('.fp7','',$db);
	$db_title = ucfirst($layout_name);
	switch ($db) {
		case 'bryophytes.fp7':
			echo '<h3>' . $db_title . ' Plant Database - University of British Columbia Herbarium</h3>';
			$search_string = 'search_results.php?db=' . $db . '&layout=' . $layout_name . '_web_results';
			echo '<form action="' . $search_string . '" method="post" name="herb_search">';
			break;
		case 'fungi.fp7':
			echo '<h3>Fungi Plant Database - University of British Columbia Herbarium</h3>';
			$search_string = 'search_results.php?db=fungi.fp7&layout=fungi_websearch_advanced';
			echo '<form action="' . $search_string . '" method="post" name="herb_search">';
			$layout_name = 'fungi_web_search';			
			break;
		case 'lichen.fp7':
			echo '<h3>Lichen Plant Database - University of British Columbia Herbarium</h3>';
			$search_string = 'search_results.php?db=lichen.fp7&layout=lichen_websearch_advanced';
			echo '<form action="' . $search_string . '" method="post" name="herb_search">';
			$layout_name = 'lichen_web_search';
			break;
		case 'ubcalgae.fp7':
			echo '<h3>Algae Plant Database - University of British Columbia Herbarium</h3>';
			$search_string = 'search_results.php?db=ubcalgae.fp7&layout=ubcalgae_websearch_advanced';
			echo '<form action="' . $search_string . '" method="post" name="herb_search">';
			$layout_name = 'ubcalgae_web_search';
			break;
		case 'vwsp.fp7':
			echo '<h3>Vascular Plant Database - University of British Columbia Herbarium</h3>';
			$search_string = 'search_results.php?db=vwsp.fp7&layout=vwsp_web_results';
			echo '<form action="' . $search_string . '" method="post" name="herb_search">';
			break;
		default:
			echo '<h3>Error:</h3>';			
			echo '<p>Please supply a database name to search.</p>';
			echo '<meta http-equiv="refresh" content="5;url=index.php" />';
			exit;
	}

	require_once '/Users/botany/db.inc.php';

	# this is the include for the API for PHP
	require_once ('FileMaker.php');

	# instantiate a new FileMaker object
	$fm = new FileMaker(FM_FILE, FM_HOST, FM_USER, FM_PASS);

	# get the layout as an object
	$layout_object = $fm->getLayout($layout_name);

	# check for errors
	if (FileMaker::isError($layout_object)) {
		die('<p>'.$record->getMessage().' (error '.$record->code.')</p>');
	}

	# get the fields as an array of objects
	$field_objects = $layout_object->getFields();

	$use_custom_titles = false;
	if (is_file('includes/' . $layout_name . '_web_search_titles.txt')) {
		$use_custom_titles = true;	
		$titles = file('includes/' . $layout_name . '_web_search_titles.txt');
		foreach ($titles as $line_num => $title_pair)
		{
			$title_pair = trim($title_pair);		
			if (!empty($title_pair)) {		
				$titles_add = explode(':', $title_pair);
				$field_name = trim($titles_add[0]);
				$title = trim($titles_add[1]);		
				$display_array[$field_name] = $title;
			}
		}
	}

	$page_content = '<table cellpadding="2" cellspacing="2" border="0">';
	foreach($field_objects as $field_object) {
		$field_name = $field_object->getName();
		if ($use_custom_titles) {		
			if (array_key_exists($field_name, $display_array)) {
				$field_title = $display_array[$field_name];
			}
		} else {
			$field_title = $field_name;
		}
		$page_content .= '<tr><td class="h1">' . $field_title . '</td><td class="h1"><input name="'. $field_name .'" type="text" size="25" /></td></tr>';	
	}
	$page_content .= '</table>';
	echo $page_content;
?>

<input type="submit" value="Search" />    
</form>
<?php
	include 'includes/footer.php'; 
?>
